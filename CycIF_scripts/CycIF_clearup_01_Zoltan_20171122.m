%% Triplet remove zeros & background (A488 & A555)
%% Jerry LIn 2017/08/10

slideNames = {'BP_40b_176',...
'i074_40a_132',...
'i074_40b_132',...
'i109_40_80',...
'i151_40_90',...
'i221_40a_18',...
'i221_40b_156',...
'i493_40a_117',...
'i493_40b_165',...
'i779_40b_460',...
'i781_40a_156',...
'i781_40b_132',...
'i943_40_150',...
'LP1_40a_90',...
'LP1_40b_63',...
'LP2_40a_180',...
'LP2_40b_170',...
'NL1_40_110',...
'NL2_40_484',...
'PS1_40a_63',...
'PS1_40b_42',...
'PS2_40_100',...
'PS3_40a_42',...
'PS3_40b_90',...
'PS4_40a_135',...
'PS4_40b_54',...
'PS5_40a_108',...
'PS5_40b_120',...
'PS6_40b_56'};

samplesize = 5000;


%% remove image processing artifacts (zeros)
for i =1:length(slideNames)
        name1 = strcat('data',slideNames{i});
        disp(strcat('Removing zeros',{' '},name1));
        data1 = eval(name1);
        names = data1.Properties.VariableNames;
        idx = find(ismember(names,'AREA'))-1;
        data2 = data1{:,1:idx};
        flag = prod(data2,2);
        data3 = data1(flag>0,:);
        eval(strcat(name1,'=data3;'));
end

clear data1 data2 data3;
allsample = table;

%% remove autofluorescence background on A488 & A555 channels

for i =1:length(slideNames)
        name1 = strcat('data',slideNames{i});
        disp(strcat('Removing backgrounds',{' '},name1));
        data1 = eval(name1);
        [A488p,~,~,~,~]=findgate3(log(data1.A488+5),0,0.05,0);
        [A555p,~,~,~,~]=findgate3(log(data1.A555+5),0,0.05,0);
        data1.A555p = A555p;
        data1.A488p = A488p;
        
        data2 = data1(data1.A488p==0,:);
        data2 = data2(data2.A555p==0,:);
        %disp(strcat('Processsing',{' '},name1));
        eval(strcat(name1,'=data2;'));
        sample1 = datasample(data2,samplesize);
        eval(strcat('sample',slideNames{i},'=sample1;'));
        
        sample1.slidename = repmat(slideNames(i),length(sample1.X),1);
        if(isempty(allsample))
            allsample = sample1;
        else
            allsample = vertcat(allsample,sample1);
        end
end

clear A555p A488p data1 data2 sample1;
        